name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 1.2.3)"
        required: true
        type: string
      prerelease:
        description: "Is this a pre-release?"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable using build script
        run: |
          scripts\build.bat

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: executable-windows
          path: |
            dist/

  release:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        run: |
          if ! echo "${{ inputs.version }}" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$'; then
            echo "❌ Invalid version format. Please use semantic versioning (e.g., 1.2.3 or 1.2.3-beta)"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          TAG_NAME="v${{ inputs.version }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "❌ Tag $TAG_NAME already exists!"
            exit 1
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Archive RFID Agent folder
        run: |
          # Check if the RFID Agent folder exists in the downloaded artifacts
          if [ -d "executable-windows/RFID Agent" ]; then
            echo "Found RFID Agent folder, creating ZIP archive..."
            cd "executable-windows"
            # Create ZIP archive for Windows compatibility
            zip -r "../RFID-Agent-v${{ inputs.version }}-portable.zip" "RFID Agent"
            cd ..
            echo "Archive created: RFID-Agent-v${{ inputs.version }}-portable.zip"
            ls -la *.zip
          else
            echo "RFID Agent folder not found in artifacts"
            echo "Available files in executable-windows:"
            ls -la executable-windows/ || echo "executable-windows directory not found"
          fi

      - name: Prepare installation assets
        run: |
          # Create a directory for release assets
          mkdir -p release-assets

          # Copy installation files if they exist
          if [ -d "installation" ]; then
            echo "Found installation folder, copying files..."
            cp -r installation/* release-assets/ 2>/dev/null || true
            ls -la release-assets/
          else
            echo "No installation folder found"
          fi

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" ${LAST_TAG}..HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" -10)
          fi

          # Save changelog to file
          cat > changelog.md << EOF
          ## Changes in v${{ inputs.version }}

          ${COMMITS}

          ## Downloads
          - **Windows Portable**: RFID-Agent-v${{ inputs.version }}-portable.zip (Complete application folder)
          - **Windows Installer**: Available in installation assets (if included)

          ## Installation

          ### Option 1: Portable Version (Recommended)
          1. Download \`RFID-Agent-v${{ inputs.version }}-portable.zip\`
          2. Extract the ZIP file to your desired location
          3. Run \`RFID Agent.exe\` from the extracted folder

          ### Option 2: Use Installer (if available)
          Download and run the installer from the release assets.

          ## System Requirements
          - Windows 10 or later
          - No additional dependencies required
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ inputs.version }}
          name: Release v${{ inputs.version }}
          body_path: changelog.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
          files: |
            executable-windows/*
            release-assets/*
            RFID-Agent-v${{ inputs.version }}-portable.zip
          make_latest: ${{ !inputs.prerelease }}

      - name: Success notification
        run: |
          echo "✅ Release v${{ inputs.version }} created successfully!"
          echo "🔗 Check it out at: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ inputs.version }}"
